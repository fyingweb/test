var Event=(function(){var list={},listen,trigger,remove;listen=function(key,fn){if(!list[key]){list[key]=[]}list[key].push(fn)};trigger=function(){var key=Array.prototype.shift.call(arguments);var fns=list[key];if(!fns||fns.length===0){return}for(var i=0;i<fns.length;i++){var fn=fns[i];fn.apply(this,arguments)}};remove=function(key,fn){var fns=list[key];if(!fns){return false}if(!fn){fns&&(fns.length=0)}else{for(var i=0;i<fns.length;i++){var _fn=fns[i];if(_fn===fn){fns.splice(i,1)}}}};return{listen:listen,trigger:trigger,remove:remove}})();

function LoadMore(cfg){this.translate=0;this.scrollEventTarget=null;this.containerFilled=false;this.direction='';this.startY=0;this.startScrollTop=0;this.currentY=0;this.bottomStatus='';this.list=[];this.disabled=false;this.config={el:'loadMore',listItemTemplate:'<li>{{item}}</li>',bFreshTemplate:'',autoFill:true,distanceIndex:2,maxDistance:0,bottomPullText:'上拉刷新',bottomDropText:'释放更新',bottomLoadingText:'加载中...',bottomDistance:70,bottomMethod:null,bottomAllLoaded:false};for(var key in cfg){if(cfg.hasOwnProperty(key)){this.config[key]=cfg[key]}}this.$el=document.querySelector('#'+this.config.el);this.$loadMoreContent=this.$el.children[0];this.$listWrapper=this.$loadMoreContent.children[0];this.init()}LoadMore.prototype=Object.assign({},LoadMore.prototype,{init:function(){var _this=this;this.registerEvent();this.appendStatusDOM();this.scrollEventTarget=this.getScrollEventTarget(this.$el);Event.trigger('bottomStatus','pull');this.config.initData(function(list){for(var i=0;i<list.length;i++){var domStr=_this.config.listItemTemplate.replace(/\{\{item\}\}/g,list[i]);var liElement=_this.parseDom(domStr);_this.$listWrapper.appendChild(liElement)}_this.list=_this.list.concat(list)});if(typeof this.config.bottomMethod==='function'){this.fillContainer();this.bindTouchEvents()}},parseDom(domTemplate){var objE=document.createElement("div");objE.innerHTML=domTemplate;return objE.childNodes[0]},registerEvent:function(){var _this=this;Event.listen('bottomStatus',function(val){var status=document.querySelector('#loadMoreBottom .status');var loading=document.querySelector('#loadMoreBottom .loading');switch(val){case'pull':_this.bottomText=_this.config.bottomAllLoaded?'暂无更多数据':_this.config.bottomPullText;break;case'drop':_this.bottomText=_this.config.bottomDropText;break;case'loading':_this.bottomText=_this.config.bottomLoadingText;break}if(val!=='loading'){status.textContent=_this.bottomText;status.style.display='';loading.style.display='none'}else{status.style.display='none';loading.style.display='';if(!_this.config.bFreshTemplate){loading.textContent=_this.bottomText}}});Event.listen('data',function(list){if(!list||list.length===0){return}for(var i=0;i<list.length;i++){var domStr=_this.config.listItemTemplate.replace(/\{\{item\}\}/g,list[i]);var liElement=_this.parseDom(domStr);_this.$listWrapper.appendChild(liElement)}_this.list=list.concat(list)});Event.listen('fresh',function(list){if(!list||list.length===0){return}_this.$listWrapper.style.display='none';_this.$listWrapper.remove();var $newListWrapper=_this.parseDom('<ul class="borrow-list" id="loadMoreList"></ul>');_this.$listWrapper=$newListWrapper;for(var i=0;i<list.length;i++){var domStr=_this.config.listItemTemplate.replace(/\{\{item\}\}/g,list[i]);var liElement=_this.parseDom(domStr);$newListWrapper.appendChild(liElement)}var loadMoreBottom=document.querySelector('#loadMoreBottom');if(loadMoreBottom){_this.$loadMoreContent.insertBefore($newListWrapper,loadMoreBottom)}else{_this.$loadMoreContent.appendChild($newListWrapper)}_this.list=list});Event.listen('translate',function(offset){_this.$loadMoreContent.style.transform='translate3d(0, '+offset+'px, 0)';_this.translate=offset});Event.listen('bottomDropped',function(isDropped){var loadMoreContent=document.querySelector('#loadMoreContent');if(isDropped){_this.$loadMoreContent.classList.add('is-dropped')}else{_this.$loadMoreContent.classList.remove('is-dropped')}_this.bottomDropped=isDropped})},appendStatusDOM:function(){var bFreshTemplate=this.config.bFreshTemplate||'<span class="loading" style="display: none;"></span>';if(this.config.bottomMethod){var template='<div class="loadmore-bottom" id="loadMoreBottom"><span class="status" style=""></span>'+bFreshTemplate+'</div>';var bFresh=this.parseDom(template);this.$loadMoreContent.appendChild(bFresh)}},getScrollEventTarget:function(element){var currentNode=element;while(currentNode&&currentNode.tagName!=='HTML'&&currentNode.tagName!=='BODY'&&currentNode.nodeType===1){var overflowY=document.defaultView.getComputedStyle(currentNode).overflowY;if(overflowY==='scroll'||overflowY==='auto'){return currentNode}currentNode=currentNode.parentNode}return window},fillContainer:function(){if(this.config.autoFill){if(this.scrollEventTarget===window){this.containerFilled=this.$el.getBoundingClientRect().bottom>=document.documentElement.getBoundingClientRect().bottom}else{this.containerFilled=this.$el.getBoundingClientRect().bottom>=this.scrollEventTarget.getBoundingClientRect().bottom}if(!this.containerFilled){Event.trigger('bottomStatus','loading');Event.trigger('translate',0);var data=this.config.bottomMethod(function(list){Event.trigger('data',list);Event.trigger('bottomStatus','pull');Event.trigger('translate',0)})}}},bindTouchEvents:function(){this.$el._this=this;this.$el.addEventListener('touchstart',this.handleTouchStart);this.$el.addEventListener('touchmove',this.handleTouchMove);this.$el.addEventListener('touchend',this.handleTouchEnd)},getScrollTop:function(element){if(element===window){return Math.max(window.pageYOffset||0,document.documentElement.scrollTop)}else{return element.scrollTop}},checkBottomReached:function(){if(this.scrollEventTarget===window){return document.body.scrollTop+document.documentElement.clientHeight>=document.body.scrollHeight}else{return this.$el.getBoundingClientRect().bottom<=this.scrollEventTarget.getBoundingClientRect().bottom+1}},onBottomLoaded:function(list,isAllLoaded){Event.trigger('bottomStatus','pull');Event.trigger('bottomDropped',false);Event.trigger('data',list);if(this.scrollEventTarget===window){document.body.scrollTop+=20}else{this.scrollEventTarget.scrollTop+=20}Event.trigger('translate',0);this.config.bottomAllLoaded=isAllLoaded},handleTouchStart:function(event){var _this=this._this;if(!_this.disabled){_this.startY=event.touches[0].clientY;_this.startScrollTop=_this.getScrollTop(_this.scrollEventTarget);_this.bottomReached=false;if(_this.bottomStatus!=='loading'){Event.trigger('bottomDropped',false);Event.trigger('bottomStatus','pull')}}},handleTouchMove:function(event){var _this=this._this;if(!_this.disabled){if(_this.startY<_this.$el.getBoundingClientRect().top&&_this.startY>_this.$el.getBoundingClientRect().bottom){return}_this.currentY=event.touches[0].clientY;var distance=(_this.currentY-_this.startY)/_this.config.distanceIndex;_this.direction=distance>0?'down':'up';if(_this.direction==='up'){_this.bottomReached=_this.bottomReached||_this.checkBottomReached()}if(typeof _this.config.bottomMethod==='function'&&_this.direction==='up'&&_this.bottomReached&&_this.bottomStatus!=='loading'&&!_this.config.bottomAllLoaded){event.preventDefault();event.stopPropagation();if(_this.config.maxDistance>0){_this.translate=Math.abs(distance)<=_this.config.maxDistance?_this.getScrollTop(_this.scrollEventTarget)-_this.startScrollTop+distance:_this.translate}else{_this.translate=_this.getScrollTop(_this.scrollEventTarget)-_this.startScrollTop+distance}if(_this.translate>0){_this.translate=0}_this.bottomStatus=-_this.translate>=_this.config.bottomDistance?'drop':'pull';Event.trigger('bottomStatus',_this.bottomStatus);Event.trigger('translate',_this.translate)}}},handleTouchEnd:function(){var _this=this._this;if(_this.direction==='up'&&_this.bottomReached&&_this.translate<0){Event.trigger('bottomDropped',true);_this.bottomReached=false;if(_this.bottomStatus==='drop'){Event.trigger('bottomStatus','loading');Event.trigger('translate',-20);_this.disabled=true;_this.config.bottomMethod(function(){var args=[].slice.call(arguments);_this.onBottomLoaded.apply(_this,args);_this.disabled=false})}else{Event.trigger('translate',0);Event.trigger('bottomStatus','pull')}}_this.direction=''}});